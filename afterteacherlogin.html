<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<link rel="stylesheet" href="teacher.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

    <body>

<div class="topbar">
    <div class="logo">ğŸ‘©â€ğŸ« <span>Teacher Dashboard</span></div>
    <div class="top-actions">
        <button onclick="toggleTheme()">ğŸŒ™</button>
        <button onclick="logout()"
            style="background:#ff4d4d;color:white;padding:8px 15px; border:none;border-radius:8px;cursor:pointer;font-weight:bold;">
            Logout
        </button>
    </div>
</div>

<div class="container">
    <h2>ğŸ“Š Class Summary</h2>
    <p>Total Students: <span id="totalStudents">0</span></p>
    <p>Average Score: <span id="classAverage">0</span></p>
</div>

<div class="container">
    <h2>ğŸ“˜ Attendance</h2>
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <input type="text" id="newStudentName" placeholder="Enter Student Name" style="flex: 1;">
        <button onclick="addStudent()" id="addStudentBtn">â• Add Student</button>
        <button onclick="saveAttendance()" id="saveBtn">ğŸ’¾ Save Attendance</button>
    </div>

    <table id="attendanceTable" style="width:100%;">
        <thead>
            <tr>
                <th>Name</th>
                <th>Present Today</th>
                <th>Attendance %</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="container">
    <h2>ğŸ“¤ Upload Master Questions</h2>
    <p style="color:#aaa; font-size:0.9rem; margin-bottom: 15px;">Upload the PDF questions for students to view.</p>
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <input type="file" id="questionFile" accept="application/pdf">
        <button onclick="uploadQuestions()" id="uploadQBtn" style="background:#667eea; color:white;">Post Questions to Students</button>
    </div>
    <p id="uploadStatus" style="margin-top:10px; font-size:0.9rem;"></p>
</div>

<div class="container">
    <h2>ğŸ“ Assignment Evaluations</h2>
    <div id="classList"></div>

    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 30px 0;">

    <h3>ğŸ† Top Performers</h3>
    <div id="leaderboard"></div>
</div>

<script>
    const supabaseUrl = "https://dezrvgfkzwdpdzztbiyo.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlenJ2Z2ZrendkcGR6enRiaXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTQ0MDEsImV4cCI6MjA4NjczMDQwMX0.yspqyhyhG4k3V47vGi29eemNN-BPLhefrBfzvy82JLo";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let students = [];

    async function loadAttendance(){
        const { data, error } = await supabaseClient.from("attendance").select("*");
        if(error || !data) return;

        const uniqueStudents = [...new Set(data.map(s => s.student_name))];
        students = uniqueStudents.map(name => {
            const studentRecords = data.filter(s => s.student_name === name);
            const totalDays = studentRecords.length;
            const presentDays = studentRecords.filter(s => s.present).length;
            const percentage = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(1) : 0;
            return { name, presentToday: false, percentage };
        });
        renderAttendance();
    }

    function renderAttendance(){
        const tbody = document.querySelector("#attendanceTable tbody");
        tbody.innerHTML = "";
        students.forEach((student, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${student.name}</td>
                <td><input type="checkbox" ${student.presentToday ? "checked":""} onchange="togglePresent(${index})"></td>
                <td>${student.percentage}%</td>
                <td><button onclick="removeStudent(${index})" style="background:transparent; border:none; cursor:pointer;">âŒ</button></td>
            `;
            tbody.appendChild(row);
        });
    }

    function addStudent(){
        const name = document.getElementById("newStudentName").value.trim();
        if(!name) return;
        students.push({ name, presentToday: false, percentage: 0 });
        document.getElementById("newStudentName").value = "";
        renderAttendance();
    }

    function togglePresent(index) { students[index].presentToday = !students[index].presentToday; }
    function removeStudent(index) { students.splice(index, 1); renderAttendance(); }

    async function saveAttendance(){
        const today = new Date().toISOString().split("T")[0];
        for(const student of students){
            await supabaseClient.from("attendance").upsert([
                { student_name: student.name, date: today, present: student.presentToday }
            ], { onConflict: ["student_name", "date"] });
        }
        alert("Attendance Saved");
        loadAttendance();
    }

    async function loadDashboard(){
        const { data: submissions } = await supabaseClient.from("assignments").select("*").order("created_at", { ascending: false });
        let container = document.getElementById("classList");
        container.innerHTML = "";
        if(!submissions || submissions.length === 0){
            container.innerHTML = "<h3>No submissions found.</h3>";
            return;
        }
        submissions.forEach(sub => {
            let box = document.createElement("div");
            box.className = "assignment-box"; 
            box.style.marginBottom = "15px";
            box.innerHTML = `
                <strong>ğŸ‘¤ ${sub.student_name}</strong><br>
                ${sub.subject} - ${sub.title}<br>
                <b>Marks:</b> ${sub.total_marks ?? "Pending"}<br>
                <b>Status:</b> ${sub.status ?? "Pending"}<br>
                <button onclick="window.open('${sub.file_url}')" style="margin-top:10px; background:#00ff95; color:black; padding:5px 10px;">View PDF</button>
            `;
            container.appendChild(box);
        });
    }

    async function loadClassSummary(){
        const { data: submissions } = await supabaseClient.from("assignments").select("*");
        if(!submissions) return;
        const uniqueStudents = [...new Set(submissions.map(s => s.student_name))];
        document.getElementById("totalStudents").innerText = uniqueStudents.length;
        let graded = submissions.filter(s => s.total_marks !== null);
        if(graded.length > 0){
            let avg = graded.reduce((a, b) => a + b.total_marks, 0) / graded.length;
            document.getElementById("classAverage").innerText = avg.toFixed(1) + " / 100";
        }
    }

    async function loadLeaderboard(){
        const { data: submissions } = await supabaseClient.from("assignments").select("*");
        if(!submissions) return;
        let studentScores = {};
        submissions.forEach(sub => {
            if(sub.total_marks !== null){
                if(!studentScores[sub.student_name]) studentScores[sub.student_name] = [];
                studentScores[sub.student_name].push(sub.total_marks);
            }
        });
        let averages = Object.keys(studentScores).map(name => {
            let avg = studentScores[name].reduce((a, b) => a + b) / studentScores[name].length;
            return { name, avg };
        });
        averages.sort((a, b) => b.avg - a.avg);
        let leaderboard = document.getElementById("leaderboard");
        leaderboard.innerHTML = "";
        averages.slice(0, 3).forEach((student, index) => {
            leaderboard.innerHTML += `<div style="margin-bottom:8px;">ğŸ… #${index+1} ${student.name} - ${student.avg.toFixed(1)}</div>`;
        });
    }

    async function uploadQuestions() {
        const fileInput = document.getElementById("questionFile");
        const status = document.getElementById("uploadStatus");
        const file = fileInput.files[0];
        if (!file) { alert("Please select a PDF file first."); return; }
        status.innerText = "Uploading...";
        const fileName = "questions-" + Date.now() + ".pdf";
        try {
            const { error: uploadError } = await supabaseClient.storage.from("assignments").upload(fileName, file);
            if (uploadError) throw uploadError;
            const { data: publicData } = supabaseClient.storage.from("assignments").getPublicUrl(fileName);
            const { error: dbError } = await supabaseClient.from("question_papers").upsert([{ id: 1, file_url: publicData.publicUrl, title: file.name }]);
            if (dbError) throw dbError;
            status.style.color = "#00ff95";
            status.innerText = "Questions successfully posted to students!";
        } catch (err) {
            status.style.color = "#ff4d4d";
            status.innerText = "Error: " + err.message;
        }
    }

    function toggleTheme() { document.body.classList.toggle("light-mode"); }
    function logout() { window.location.href = "index.html"; }

    loadAttendance();
    loadDashboard();
    loadClassSummary();
    loadLeaderboard();
</script>

</body>
</html>
